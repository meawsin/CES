<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Request Faculty - Course Evaluation System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #10b981; /* emerald-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); /* emerald-500 with 20% opacity */
        }
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
        .animate-fade-in-up {
            animation: fadeInFromBottom 0.8s ease-out forwards;
        }
        @keyframes fadeInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" style="background: linear-gradient(135deg, #e1f0df 0%, #d0e8e6 100%);">
<!-- Improved Tab Bar Navigation -->
<div class="w-full bg-white shadow-sm sticky top-0 z-20">
  <div class="flex items-center justify-between px-8" style="min-height:64px;">
    <div class="flex gap-8">
      <button id="tabPendingEvaluations" class="tab-button flex items-center gap-2 text-gray-600 hover:text-teal-700 px-5 py-3 rounded-t-md transition-all">
        <i class="fas fa-hourglass-half"></i>Pending
      </button>
      <button id="tabMyProfile" class="tab-button flex items-center gap-2 text-gray-600 hover:text-teal-700 px-5 py-3 rounded-t-md transition-all">
        <i class="fas fa-user"></i>Profile
      </button>
      <button id="tabCompletedEvaluations" class="tab-button flex items-center gap-2 text-gray-600 hover:text-teal-700 px-5 py-3 rounded-t-md transition-all">
        <i class="fas fa-clipboard-check"></i>Completed
      </button>
      <button id="tabComplaints" class="tab-button flex items-center gap-2 text-gray-600 hover:text-teal-700 px-5 py-3 rounded-t-md transition-all">
        <i class="fas fa-comment-alt"></i>Complaint
      </button>
      <button id="tabRequestFaculty" class="tab-button flex items-center gap-2 text-gray-600 hover:text-teal-700 px-5 py-3 rounded-t-md transition-all">
        <i class="fas fa-chalkboard-teacher"></i>Request Faculty
      </button>
    </div>
    <button id="logoutBtn" class="ml-8 bg-teal-400 hover:bg-teal-300 text-teal-900 font-semibold px-6 py-2 rounded-lg shadow transition duration-300 ease-in-out flex items-center gap-2"><i class="fas fa-sign-out-alt"></i>Logout</button>
  </div>
</div>
<!-- End Improved Tab Bar Navigation -->
    <div style="height:64px;"></div>

    <main class="container mx-auto main-container flex-grow pt-20">
        <div id="requestFormContainer" class="card shadow-lg animate-fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-4 text-center">Request a Faculty for an Upcoming Course</h2>
            <p class="text-gray-700 mb-8 text-center leading-relaxed">
                Use this form to request a specific faculty member for an upcoming course. Your request will be reviewed by the administration.
            </p>

            <form id="facultyRequestForm" class="space-y-6">
                <div>
                    <label for="courseCode" class="block text-sm font-medium text-gray-700 mb-1">
                        Select Upcoming Course <span class="text-red-500">*</span>
                    </label>
                    <select id="courseCode" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm">
                        <option value="">Loading courses...</option>
                    </select>
                </div>

                <div>
                    <label for="requestedFacultyName" class="block text-sm font-medium text-gray-700 mb-1">
                        Requested Faculty Name (Optional)
                    </label>
                    <input type="text" id="requestedFacultyName"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                           placeholder="e.g., Dr. Amina Rahman" />
                </div>

                <div>
                    <label for="requestDetails" class="block text-sm font-medium text-gray-700 mb-1">
                        Details of your Request <span class="text-red-500">*</span>
                    </label>
                    <textarea id="requestDetails" rows="5" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm"
                              placeholder="Please explain why you are requesting this faculty member for the selected course..."></textarea>
                </div>

                <div id="messageBox" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline" id="messageText"></span>
                </div>

                <button type="submit"
                        class="w-full flex justify-center items-center py-3 px-6 border border-transparent rounded-lg shadow-md
                               text-lg font-medium text-white bg-blue-600 hover:bg-blue-700
                               focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500
                               transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-paper-plane mr-3"></i> Submit Request
                </button>
            </form>

            <div id="submissionSuccess" class="hidden text-center text-green-700 font-bold text-xl mt-6 p-6 bg-green-100 rounded-lg shadow-md animate-fade-in-up">
                <i class="fas fa-check-circle fa-3x mb-4 text-green-600"></i><br>
                Your faculty request has been submitted successfully!
                <button id="goToDashboardAfterSubmit" class="mt-6 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-home mr-2"></i>Go to Dashboard
                </button>
            </div>
        </div>
    </main>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:5000/api';

        document.addEventListener('DOMContentLoaded', () => {
            const studentToken = localStorage.getItem('studentToken');
            if (!studentToken) {
                alert('You are not logged in. Redirecting to login.');
                window.location.href = 'student_login.html';
                return;
            }

            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.clear();
                window.location.href = 'student_login.html';
            });
            document.getElementById('goToDashboardAfterSubmit').addEventListener('click', () => {
                window.location.href = 'student_dashboard.html';
            });

            loadUpcomingCourses(studentToken);

            document.getElementById('facultyRequestForm').addEventListener('submit', (e) => {
                e.preventDefault();
                submitFacultyRequest(studentToken);
            });
        });

        async function authenticatedFetch(url, options = {}) {
            const studentToken = localStorage.getItem('studentToken');
            if (!studentToken) {
                alert('Session expired or not logged in. Please log in again.');
                localStorage.clear();
                window.location.href = 'student_login.html';
                throw new Error('No authentication token found.');
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${studentToken}`,
            };

            const response = await fetch(url, options);

            if (response.status === 401) {
                alert('Session expired or unauthorized. Please log in again.');
                localStorage.clear();
                window.location.href = 'student_login.html';
                throw new Error('Unauthorized access, redirecting to login.');
            }

            return response;
        }

        async function loadUpcomingCourses(token) {
            const courseSelect = document.getElementById('courseCode');
            courseSelect.innerHTML = '<option value="">Loading courses...</option>'; // Show loading

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/student/courses/upcoming`);

                if (response.ok) {
                    const courses = await response.json();
                    courseSelect.innerHTML = '<option value="">-- Select a Course --</option>'; // Default option
                    if (courses.length === 0) {
                        courseSelect.innerHTML = '<option value="">No upcoming courses available</option>';
                        courseSelect.disabled = true; // Disable if no courses
                    } else {
                        courseSelect.disabled = false;
                        courses.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.course_code;
                            option.textContent = `${course.course_name} (${course.course_code})`;
                            courseSelect.appendChild(option);
                        });
                    }
                } else {
                    const errorData = await response.json();
                    courseSelect.innerHTML = `<option value="">Failed to load courses: ${errorData.message}</option>`;
                    courseSelect.disabled = true;
                    console.error('Failed to load upcoming courses:', errorData);
                }
            } catch (error) {
                console.error('Network error loading upcoming courses:', error);
                courseSelect.innerHTML = '<option value="">Network error loading courses</option>';
                courseSelect.disabled = true;
            }
        }

        async function submitFacultyRequest(token) {
            const courseCode = document.getElementById('courseCode').value;
            const requestedFacultyName = document.getElementById('requestedFacultyName').value.trim();
            const requestDetails = document.getElementById('requestDetails').value.trim();
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const submissionSuccess = document.getElementById('submissionSuccess');

            messageBox.classList.add('hidden');
            submissionSuccess.classList.add('hidden');

            if (!courseCode) {
                messageText.textContent = 'Please select a course.';
                messageBox.classList.remove('hidden');
                return;
            }
            if (!requestDetails) {
                messageText.textContent = 'Please provide details for your request.';
                messageBox.classList.remove('hidden');
                return;
            }

            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/student/requests/faculty_request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        course_code: courseCode,
                        requested_faculty_name: requestedFacultyName || null, // Send null if empty
                        details: requestDetails
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('requestFormContainer').classList.add('hidden');
                    submissionSuccess.classList.remove('hidden');
                    document.getElementById('facultyRequestForm').reset(); // Clear form
                } else {
                    messageText.textContent = data.message || 'Failed to submit request. Please try again.';
                    messageBox.classList.remove('hidden');
                    console.error('Request submission error:', data);
                }
            } catch (error) {
                console.error('Network error during request submission:', error);
                messageText.textContent = 'Network error or server unavailable. Please try again later.';
                messageBox.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
